<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="admin">
  
  	<!-- 대시보드 - 첫번째 차트 -->
	<select id="selectChart1" resultType="AdminDashboard1">
		SELECT SUBSTR(TO_CHAR(ODATE, 'YYYY/MM/DD'), 6, 2) AS MM, SUM(O.OCOUNT * P.PPRICE * 0.1) AS REVENUE
		    FROM "ORDER" O JOIN PRODUCT P ON O.PID = P.PID
		    WHERE SUBSTR(TO_CHAR(ODATE, 'YYYY/MM/DD'), 1, 4) = '2022'
		    GROUP BY SUBSTR(TO_CHAR(ODATE, 'YYYY/MM/DD'), 6, 2)
		    ORDER BY MM ASC
	</select>

  	<!-- 대시보드 - 두번째 차트 -->
	<select id="selectChart2" resultType="AdminDashboard2">
		SELECT CID, SUM(PSALES) AS SALES
		    FROM PRODUCT
		    GROUP BY CID
		    ORDER BY CID ASC
	</select>

 	<!-- 대시보드 - 세번째 차트 -->
	<select id="selectChart3" resultType="AdminDashboard3">
		SELECT SUBSTR(TO_CHAR(ODATE, 'YYYY/MM/DD'), 6, 2) AS MM, COUNT(OID) AS CNT
		    FROM "ORDER"
		    WHERE SUBSTR(TO_CHAR(ODATE, 'YYYY/MM/DD'), 1, 4) = '2022'
		    GROUP BY SUBSTR(TO_CHAR(ODATE, 'YYYY/MM/DD'), 6, 2)
		    ORDER BY MM ASC
	</select>
	
  	<!-- 회원 -->
	<select id="selectMember" parameterType="map" resultType="AdminMember">
		SELECT M.PROFIMG, M.MID, M.MEMAIL, M.MNAME, 
		        (SELECT COUNT(*) FROM BOARD B WHERE B.MID = M.MID) AS POSTCNT, 
		        (SELECT COUNT(*) FROM REPLY R WHERE R.MID = M.MID) AS REPLYCNT, 
		        NVL((SELECT SUM(P.PPRICE * O.OCOUNT) FROM PRODUCT P JOIN "ORDER" O ON P.PID = O.PID WHERE O.MID = M.MID), 0) AS PAYMENT, 
		        TO_CHAR(M.MCREATE, 'YYYY.MM.DD') AS MCREATE
		    FROM MEMBER M 
		    WHERE M.MROLE = 'M' AND M.MSTATE = 'A'
		    <if test="searchword != null and !searchword.equals('')">
				AND MNAME LIKE '%'||#{searchword}||'%'
			</if>
			<choose>
				<when test="sort == 1"> <!-- 게시글수많은순 -->
					ORDER BY POSTCNT DESC, MID ASC
				</when>
				<when test="sort == 2"> <!-- 댓글수많은순 -->
					ORDER BY REPLYCNT DESC, MID ASC
				</when>
				<when test="sort == 3"> <!-- 총주문금액높은순 -->
					ORDER BY PAYMENT DESC, MID ASC
				</when>
				<otherwise>
					ORDER BY MID ASC
				</otherwise>
			</choose>
	</select>
	
  	<!-- 게시물 -->
	<select id="selectBoard" parameterType="map" resultType="AdminBoard">
		SELECT B.BID, BC.BCNAME, B.BTITLE, B.MID, B.BVIEWCOUNT, 
		        TO_CHAR(B.BCREATE, 'YYYY.MM.DD') AS BCREATE, 
		        DECODE(B.BSTATE, 'A', '활성화', '비활성화') AS BSTATE
		    FROM BOARD B JOIN BCATEGORY BC ON B.BCID = BC.BCID
		    
			<where> <!-- WHERE을 구문 앞에 추가해줌. AND/OR로 시작한다면 없애줌 -->
				<if test="searchword != null and !searchword.equals('')">
					AND BTITLE LIKE '%'||#{searchword}||'%'
				</if>
				<choose>
					<when test="category == 1"> <!-- 공지사항 -->
						AND BC.BCID = 0
					</when>
					<when test="category == 2"> <!-- 식단 -->
						AND BC.BCID = 1
					</when>
					<when test="category == 3"> <!-- 팁&노하우 -->
						AND BC.BCID = 2
					</when>
					<when test="category == 4"> <!-- 고민&질문 -->
						AND BC.BCID = 3
					</when>
				</choose>
				<if test="state != null and !state.equals('')">
					<choose>
						<when test="state == 1"> <!-- 활성화 -->
							AND BSTATE = 'A'
						</when>
						<when test="state == 2"> <!-- 비활성화 -->
							AND BSTATE = 'D'
						</when>
					</choose>
				</if>
			</where>
			
		    ORDER BY B.BID DESC
	</select>
  	
  	<delete id="deleteBoard" parameterType="string">
		DELETE FROM BOARD
		    WHERE BID = #{bid}
  	</delete>
  
  
  
  
  
</mapper>
